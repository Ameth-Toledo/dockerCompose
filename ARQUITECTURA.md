# ๐๏ธ Arquitectura del Sistema - KarGaps

## Diagrama General de Microservicios
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    ARQUITECTURA DE MICROSERVICIOS                    โ
โ                   Ameth de Jesus Mendez Toledo                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

                           USUARIO FINAL
                                โ
                                โ HTTP
                                โผ
                    โโโโโโโโโโโโโโโโโโโโโโโโโ
                    โ   NAVEGADOR WEB       โ
                    โ   Chrome/Firefox/etc  โ
                    โโโโโโโโโโโโโฌโโโโโโโโโโโโ
                                โ
                                โ Puerto 3000
                                โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  CONTENEDOR: ameth-frontend-kargaps                               โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ  FRONTEND - Angular 19                                      โ โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโ                                โ โ
โ  โ  โข Framework: Angular 19                                    โ โ
โ  โ  โข Lenguaje: TypeScript                                     โ โ
โ  โ  โข Estilos: Tailwind CSS                                    โ โ
โ  โ  โข Servidor: serve                                          โ โ
โ  โ  โข Puerto: 3000                                             โ โ
โ  โ                                                              โ โ
โ  โ  Componentes:                                               โ โ
โ  โ  โโโ Header (con nombre de Ameth)                          โ โ
โ  โ  โโโ Hero                                                   โ โ
โ  โ  โโโ Card Gorras                                            โ โ
โ  โ  โโโ Card Playeras                                          โ โ
โ  โ                                                              โ โ
โ  โ  Servicios:                                                 โ โ
โ  โ  โโโ AuthService                                            โ โ
โ  โ  โโโ GorrasService                                          โ โ
โ  โ  โโโ PlayerasService                                        โ โ
โ  โ  โโโ UsersService                                           โ โ
โ  โ  โโโ CarritoService                                         โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โ HTTP REST API
                            โ http://backend:5000/api
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  CONTENEDOR: ameth-backend-kargaps                                โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ  BACKEND API - Node.js + Express                            โ โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                       โ โ
โ  โ  โข Runtime: Node.js 20                                      โ โ
โ  โ  โข Framework: Express 5                                     โ โ
โ  โ  โข Lenguaje: TypeScript                                     โ โ
โ  โ  โข Arquitectura: Hexagonal (DDD)                            โ โ
โ  โ  โข Puerto: 5000                                             โ โ
โ  โ                                                              โ โ
โ  โ  Endpoints Principales:                                     โ โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                  โ โ
โ  โ  โ /api/users/toledo    [GET]           โ โ Endpoint       โ โ
โ  โ  โ Retorna: "Ameth de Jesus             โ   Personalizado  โ โ
โ  โ  โ          Mendez Toledo"              โ                  โ โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                  โ โ
โ  โ                                                              โ โ
โ  โ  Mรณdulos (Arquitectura Hexagonal):                          โ โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ        โ โ
โ  โ  โ USERS                                          โ        โ โ
โ  โ  โ โโโ Domain (Entities, Repository Interface)   โ        โ โ
โ  โ  โ โโโ Application (Use Cases)                   โ        โ โ
โ  โ  โ โโโ Infrastructure                             โ        โ โ
โ  โ  โ     โโโ Controllers                            โ        โ โ
โ  โ  โ     โโโ Adapters (PostgreSQL)                 โ        โ โ
โ  โ  โ     โโโ Routes                                 โ        โ โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ        โ โ
โ  โ                                                              โ โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ        โ โ
โ  โ  โ GORRAS                                         โ        โ โ
โ  โ  โ โโโ Domain                                     โ        โ โ
โ  โ  โ โโโ Application (CRUD Use Cases)              โ        โ โ
โ  โ  โ โโโ Infrastructure                             โ        โ โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ        โ โ
โ  โ                                                              โ โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ        โ โ
โ  โ  โ PLAYERAS                                       โ        โ โ
โ  โ  โ โโโ Domain                                     โ        โ โ
โ  โ  โ โโโ Application (CRUD Use Cases)              โ        โ โ
โ  โ  โ โโโ Infrastructure                             โ        โ โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ        โ โ
โ  โ                                                              โ โ
โ  โ  Core:                                                      โ โ
โ  โ  โโโ Security (JWT, bcrypt, auth middleware)               โ โ
โ  โ  โโโ Database (PostgreSQL connection)                      โ โ
โ  โ  โโโ Cloudinary (Image upload)                             โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โ SQL Queries
                            โ postgresql://ameth_user:***@database:5432
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  CONTENEDOR: ameth-database-kargaps                               โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ  BASE DE DATOS - PostgreSQL 17 Alpine                      โ โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                 โ โ
โ  โ  โข Motor: PostgreSQL 17                                     โ โ
โ  โ  โข Base de Datos: kargaps_db                               โ โ
โ  โ  โข Usuario: ameth_user                                      โ โ
โ  โ  โข Puerto: 5432                                             โ โ
โ  โ                                                              โ โ
โ  โ  Tablas:                                                    โ โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                  โ โ
โ  โ  โ roles                                โ                  โ โ
โ  โ  โ โโโ id (PK)                          โ                  โ โ
โ  โ  โ โโโ nombre                           โ                  โ โ
โ  โ  โ โโโ descripcion                      โ                  โ โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                  โ โ
โ  โ                                                              โ โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                  โ โ
โ  โ  โ usuarios                             โ                  โ โ
โ  โ  โ โโโ id (PK)                          โ                  โ โ
โ  โ  โ โโโ nombres                          โ                  โ โ
โ  โ  โ โโโ apellido_paterno                 โ                  โ โ
โ  โ  โ โโโ apellido_materno                 โ                  โ โ
โ  โ  โ โโโ email (UNIQUE)                   โ                  โ โ
โ  โ  โ โโโ password_hash                    โ                  โ โ
โ  โ  โ โโโ rol_id (FK โ roles)              โ                  โ โ
โ  โ  โ โโโ avatar                           โ                  โ โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                  โ โ
โ  โ                                                              โ โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                  โ โ
โ  โ  โ gorras                               โ                  โ โ
โ  โ  โ โโโ id (PK)                          โ                  โ โ
โ  โ  โ โโโ nombre                           โ                  โ โ
โ  โ  โ โโโ descripcion                      โ                  โ โ
โ  โ  โ โโโ precio                           โ                  โ โ
โ  โ  โ โโโ stock                            โ                  โ โ
โ  โ  โ โโโ color                            โ                  โ โ
โ  โ  โ โโโ imagen_url                       โ                  โ โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                  โ โ
โ  โ                                                              โ โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                  โ โ
โ  โ  โ playeras                             โ                  โ โ
โ  โ  โ โโโ id (PK)                          โ                  โ โ
โ  โ  โ โโโ nombre                           โ                  โ โ
โ  โ  โ โโโ descripcion                      โ                  โ โ
โ  โ  โ โโโ precio                           โ                  โ โ
โ  โ  โ โโโ stock                            โ                  โ โ
โ  โ  โ โโโ color                            โ                  โ โ
โ  โ  โ โโโ talla                            โ                  โ โ
โ  โ  โ โโโ tipo                             โ                  โ โ
โ  โ  โ โโโ material                         โ                  โ โ
โ  โ  โ โโโ imagen_url                       โ                  โ โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                  โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โ Persistencia
                            โผ
                โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                โ  VOLUMEN DOCKER           โ
                โ  ameth_kargaps_           โ
                โ  persistent_data          โ
                โ                           โ
                โ  /var/lib/postgresql/data โ
                โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ


โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                        RED DOCKER                                โ
โ                     ameth-network (bridge)                       โ
โ                                                                   โ
โ  Permite la comunicaciรณn interna entre contenedores usando       โ
โ  nombres de servicio como DNS:                                   โ
โ  โข frontend โ http://backend:5000                                โ
โ  โข backend โ postgresql://database:5432                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## Flujo de Datos Detallado
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                      FLUJO DE SOLICITUD HTTP                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

1. USUARIO hace clic en "Ver Gorras"
   โ
   โผ
2. FRONTEND (Angular) โ Servicio HTTP
   โ  Mรฉtodo: gorrasService.getAll()
   โ  URL: http://backend:5000/api/gorras
   โ
   โผ
3. BACKEND recibe solicitud
   โ  Router โ /api/gorras
   โ  Controller โ GetAllGorrasController
   โ  Use Case โ GetAllGorrasUseCase
   โ
   โผ
4. REPOSITORY (Patrรณn Adapter)
   โ  PostgreSQLAdapter โ Ejecuta Query
   โ  SQL: SELECT * FROM gorras;
   โ
   โผ
5. DATABASE (PostgreSQL)
   โ  Ejecuta consulta
   โ  Lee datos del volumen persistente
   โ  Retorna filas
   โ
   โผ
6. BACKEND procesa respuesta
   โ  Mapea datos a entidades
   โ  Serializa a JSON
   โ  Status: 200 OK
   โ
   โผ
7. FRONTEND recibe JSON
   โ  Actualiza componente
   โ  Renderiza cards de gorras
   โ  Usuario ve productos
   โ
   โ FLUJO COMPLETADO
```

## Arquitectura Hexagonal (Backend)
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    ARQUITECTURA HEXAGONAL                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

                    โโโโโโโโโโโโโโโโโโโโโ
                    โ   Controllers     โ โ Capa de Presentaciรณn
                    โ  (HTTP Handlers)  โ
                    โโโโโโโโโโโฌโโโโโโโโโโ
                              โ
                              โผ
                    โโโโโโโโโโโโโโโโโโโโโ
                    โ    Use Cases      โ โ Capa de Aplicaciรณn
                    โ (Lรณgica Negocio)  โ
                    โโโโโโโโโโโฌโโโโโโโโโโ
                              โ
                              โผ
                โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                โ         DOMAIN              โ โ Nรบcleo
                โ  โโโโโโโโโโโโโโโโโโโโโโโ    โ
                โ  โ  Entities (Gorra,  โ    โ
                โ  โ  Playera, User)     โ    โ
                โ  โโโโโโโโโโโโโโโโโโโโโโโ    โ
                โ  โโโโโโโโโโโโโโโโโโโโโโโ    โ
                โ  โ  Repository         โ    โ
                โ  โ  Interfaces         โ    โ
                โ  โโโโโโโโโโโโโโโโโโโโโโโ    โ
                โโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโ
                              โ
                              โผ
                    โโโโโโโโโโโโโโโโโโโโโ
                    โ    Adapters       โ โ Capa de Infraestructura
                    โ  (PostgreSQL)     โ
                    โโโโโโโโโโโโโโโโโโโโโ
```

## Seguridad
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                      FLUJO DE AUTENTICACIรN                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

1. Usuario envรญa credenciales
   POST /api/auth/login
   { "email": "user@example.com", "password": "****" }
   โ
   โผ
2. Backend valida con bcrypt
   โข Hash almacenado vs Password ingresada
   โข bcrypt.compare(password, hash)
   โ
   โผ
3. Si es vรกlido, genera JWT
   โข Payload: { userId, email, role }
   โข Firma con SECRET_KEY
   โข Expira en 24h
   โ
   โผ
4. Frontend almacena token
   โข LocalStorage/SessionStorage
   โข Incluye en headers: Authorization: Bearer <token>
   โ
   โผ
5. Requests posteriores
   โข Backend valida JWT con middleware
   โข Extrae userId del payload
   โข Permite/Deniega acceso
```

## Persistencia de Datos
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    PERSISTENCIA CON VOLรMENES                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

Contenedor PostgreSQL
โโโ /var/lib/postgresql/data  โ Directorio de datos
โ   โโโ (archivos BD)
โ
โโโ MONTADO EN โ Volumen Docker: ameth_kargaps_persistent_data

BENEFICIOS:
โ Datos persisten aunque se detenga/elimine el contenedor
โ Backup fรกcil con `docker volume`
โ Compartible entre recreaciones del contenedor
โ Independiente del ciclo de vida del contenedor

COMPROBACIรN:
$ docker-compose down        # Detiene y elimina contenedores
$ docker volume ls           # Volumen sigue existiendo
$ docker-compose up -d       # Levanta de nuevo
$ # Los datos siguen ahรญ โ
```

## Variables de Entorno
```yaml
Backend:
  DB_HOST: database           # Nombre del servicio en red Docker
  DB_PORT: 5432
  DB_NAME: kargaps_db         # โ Base de datos con nombre de Ameth
  DB_USER: ameth_user
  DB_PASSWORD: Ameth2005
  PORT: 5000
  NODE_ENV: production

Database:
  POSTGRES_DB: kargaps_db
  POSTGRES_USER: ameth_user
  POSTGRES_PASSWORD: Ameth2005

Frontend:
  API_URL: http://backend:5000
```

---

**Desarrollado por:** Ameth de Jesus Mendez Toledo  
**Proyecto:** Microservicios con Docker Compose  
**Fecha:** 2025
